apiVersion: v1
kind: Namespace
metadata:
  name: go-security-lab
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: go-secure-server
  namespace: go-security-lab
  labels:
    app: go-secure-server
spec:
  replicas: 1
  selector:
    matchLabels:
      app: go-secure-server
  template:
    metadata:
      labels:
        app: go-secure-server
    spec:
      containers:
        - name: go-secure-server
          # Используем образ, который вы указали ранее
          image: ghcr.io/gregory-g/go-secure-server:v1
          ports:
            - containerPort: 8080
          # Добавляем securityContext для лучшей безопасности
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop: ["ALL"]
            runAsNonRoot: true
            runAsUser: 1000
---
# Service для доступа к приложению
apiVersion: v1
kind: Service
metadata:
  name: go-secure-server-svc
  namespace: go-security-lab
spec:
  selector:
    app: go-secure-server
  ports:
    - protocol: TCP
      port: 80
      targetPort: 8080
---
# Сетевая Политика (NetworkPolicy)
# Используем ранее отредактированный файл "network-policy.yaml"
# Политика устанавливает Deny-by-default, разрешая только:
# Ingress: TCP:8080 из любого места (временно)
# Egress: DNS (53/TCP/UDP) и доступ к K8s API (10.96.0.1)
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: go-server-default-deny
  namespace: go-security-lab
spec:
  podSelector:
    matchLabels:
      app: go-secure-server

  policyTypes:
    - Ingress
    - Egress

  ingress:
    # Разрешаем Ingress на порт 8080 из любого места
    - ports:
        - protocol: TCP
          port: 8080

  egress:
    # 1. Разрешаем DNS-трафик (UDP/53 и TCP/53) к kube-dns/CoreDNS
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
          podSelector:
            matchLabels:
              k8s-app: kube-dns # Или coredns, в kube-system
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

    # 2. Разрешаем доступ к Kubernetes API (Cluster IP 10.96.0.1)
    - to:
        - ipBlock:
            cidr: 10.96.0.1/32
      ports:
        - protocol: TCP
          port: 443